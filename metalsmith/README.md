# metalsmith

## Context

In Victoria the new default is for Metalsmith to 
[provision baremetal before the overcloud deploy](https://docs.openstack.org/project-deploy-guide/tripleo-docs/latest/provisioning/baremetal_provision.html).

Using [tripleo-lab](../tripleo-lab) like this:

`ansible-playbook builder.yaml -t domains -t baremetal -t vbmc`

will result in tripleo-lab using the tripleo-operator-ansible role
[tripleo_overcloud_node_provision](https://opendev.org/openstack/tripleo-operator-ansible/src/branch/master/roles/tripleo_overcloud_node_provision)
to install an OS and assign an IP to every node planned for the
overcloud. This is a different way of working as I'm used to having
introspected nodes, not deployed nodes, when I first login to the
undercloud.

## SSH'ing into the provisioned nodes

After you login to your undercloud for the first time source the stackrc
and run `metalsmith list` the way you used to run `openstack server list`.

```
(undercloud) [CentOS-8.1 - stack@undercloud ~]$ metalsmith -c "Node Name" -c "IP Addresses" list
+------------------+------------------------+
| Node Name        | IP Addresses           |
+------------------+------------------------+
| oc0-controller-0 | ctlplane=192.168.24.19 |
| oc0-controller-1 | ctlplane=192.168.24.14 |
| oc0-controller-2 | ctlplane=192.168.24.16 |
| oc0-ceph-0       | ctlplane=192.168.24.8  |
| oc0-ceph-1       | ctlplane=192.168.24.24 |
| oc0-ceph-2       | ctlplane=192.168.24.17 |
| oc0-ceph-3       | ctlplane=192.168.24.22 |
| oc0-ceph-4       | ctlplane=192.168.24.7  |
| oc0-ceph-5       | ctlplane=192.168.24.15 |
+------------------+------------------------+
(undercloud) [CentOS-8.1 - stack@undercloud ~]$ 
```

You can then `ssh heat-admin@192.168.24.19`.

## Overcloud Deployment

You should find a file in /home/stack like `overcloud-baremetal-deployed-0.yaml`:
```
(undercloud) [CentOS-8.1 - stack@undercloud ~]$ head -20 overcloud-baremetal-deployed-0.yaml 
parameter_defaults:
  CephStorageDeployedServerCount: 6
  CephStorageDeployedServerHostnameFormat: '%stackname%-cephstorage-%index%'
  ControllerDeployedServerCount: 3
  ControllerDeployedServerHostnameFormat: '%stackname%-controller-%index%'
  DeployedServerPortMap:
    ceph-0-ctlplane:
      fixed_ips:
      - ip_address: 192.168.24.8
      network:
        mtu: 1500
        tags:
        - 192.168.24.0/24
      subnets:
      - cidr: 192.168.24.0/24
        dns_nameservers:
        - 192.168.122.1
        gateway_ip: 192.168.24.1
        host_routes: []
    ceph-1-ctlplane:
(undercloud) [CentOS-8.1 - stack@undercloud ~]$ 
```

You can do your overcloud deployment by passing this file like this:

```
openstack overcloud deploy \
  -e /usr/share/openstack-tripleo-heat-templates/environments/deployed-server-environment.yaml \
  -e ~/overcloud-baremetal-deployed-0.yaml \
  --deployed-server \
  ...
```

and you'll basically be [Using Already Deployed Servers](https://docs.openstack.org/project-deploy-guide/tripleo-docs/latest/features/deployed_server.html) which will become the new default.

## Unprovisioning

You don't have to use what tripleo-lab stood up for you. You can just
shut all those nodes down like this:

```
openstack overcloud node unprovision --all \
  --stack oc0 \
  ~/metalsmith-0.yaml
```

Note that ~/metalsmith-0.yaml should have also been generated by
tripleo-lab.

You can also run [clean-disks.sh](clean-disks.sh) if you're cleaning
up after a Ceph deployment.

## Provisioning

Because tripleo-lab does this for you the first time I'm taking note
of it here:

```
openstack overcloud node provision \
  --stack oc0 \
  --output ~/overcloud-baremetal-deployed-0-new.yaml \
  ~/metalsmith-0.yaml
```

All of this is from the [existing docs](https://docs.openstack.org/project-deploy-guide/tripleo-docs/latest/provisioning/baremetal_provision.html)
but just put into the context of what I find when using tripleo-lab.

## Topologies

I normally use tripleo-lab to get a working undercloud with
introspected VMs and do everything else myself.

I used to ask for 3 controllers and 6 ceph storage servers in order 
to get the type of virtual hardware I wanted but then I'd deployment
like this using three stacks:

```
+------------------+
| control-plane    |    GlanceBackend: RBD | CephClusterName: central
+------------------+
| oc0-controller-0 |    Controller (Glance + Mon)
| oc0-controller-1 |    Controller (Glance + Mon)
| oc0-controller-2 |    Controller (Glance + Mon)
| oc0-ceph-0       |    ComputeHCI (Nova + OSD)
+------------------+

+------------------+
| dcn0             |    Standard DCN + GlanceBackend: RBD | CephClusterName: dcn0
+------------------+
| oc0-ceph-1       |    DistributedComputeHCI (Glance + Nova + Mon + OSD)
| oc0-ceph-2       |    DistributedComputeHCIScaleOut (HaProxy + Nova + OSD)
+------------------+

+------------------+
| dcn1             |    Standard DCN + GlanceBackend: RBD | CephClusterName: dcn1
+------------------+
| oc0-ceph-3       |    DistributedComputeHCI (Glance + Nova + Mon + OSD)
| oc0-ceph-4       |    DistributedComputeHCIScaleOut (HaProxy + Nova + OSD)
+------------------+
```

Thus, I might do one of the following to move into the metalsmith way
of doing things.

1. Update my [tripleo-lab/overrides.yml](../tripleo-lab/overrides.yml)
   to define something closer to the above with multiple overclouds so 
   that it can still do everything for me.
   
2. Save a bunch of different topologies in this metalsmith directory
   which are derivative works of the generated 
   [metalsmith-0.yaml](metalsmith-0.yaml) which distribute the
   nodes into different roles.
